#!/usr/bin/env sh
set -euo pipefail
IFS=$(printf '\n\t')

BSPWM_DIR=$(readlink -f "$XDG_CONFIG_HOME/bspwm")
STATE_SRC=$(readlink -f "$BSPWM_DIR/state")
USAGE_MSG=$(printf '%s\n' \
  'Usage: bspwm-mode get' \
  '       bspwm-mode set DEFAULT|MANUAL|RESIZE')

USAGE_DIE()
{
  echo "$USAGE_MSG"
  exit 1
}

COLOR_SET()
{
  bspc config focused_border_color  "$1"
  bspc config presel_feedback_color "$1"
}

mkdir -p "$BSPWM_DIR"

# TODO: lock/unlock `$STATE_SRC` to prevent race conditions

if [ "$#" = 1 ] && [ "$1" = get ]
then
  if [ ! -f "$STATE_SRC" ]
  then
    echo DEFAULT > "$STATE_SRC"
  fi

  BSPWM_STATE=$(cat "$STATE_SRC")

  case "$BSPWM_STATE" in
    DEFAULT|MANUAL|RESIZE)
      echo "$BSPWM_STATE"
      ;;
    *)
      echo DEFAULT | tee "$STATE_SRC"
  esac

  unset BSPWM_STATE

elif [ "$#" = 2 ] && [ "$1" = set ]
then
  case "$2" in
    DEFAULT)
      COLOR_SET "#ffffff"

      echo DEFAULT > "$STATE_SRC"
      ;;
    MANUAL)
      COLOR_SET "#ffb671"

      echo MANUAL > "$STATE_SRC"
      ;;
    RESIZE)
      COLOR_SET "#bdef6a"

      echo RESIZE > "$STATE_SRC"
      ;;
    *)
      USAGE_DIE
  esac

else
  USAGE_DIE
fi

unset BSPWM_DIR
unset COLOR_SET
unset STATE_SRC
unset USAGE_DIE
unset USAGE_MSG
